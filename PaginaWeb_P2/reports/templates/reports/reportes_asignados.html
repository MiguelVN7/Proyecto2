{% extends 'reports/base.html' %}
{% block content %}
<h1><i class="bi bi-clipboard-check"></i> Reportes Asignados</h1>
<div class="card p-4 mt-4">
    <form method="get" class="row g-3">
        <div class="col-md-4"><input type="text" name="q" class="form-control" placeholder="Buscar..."
            value="{{ filtro_q }}"></div>
        <div class="col-md-3">
            <select name="tipo" class="form-select">
                <option value="">Todos los tipos</option>
                {% for v, l in tipos_disponibles %}<option value="{{ v }}" {% if filtro_tipo == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <select name="prioridad" class="form-select">
                <option value="">Todas</option>
                {% for v, l in prioridades_disponibles %}<option value="{{ v }}" {% if filtro_prioridad == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
            </select>
        </div>
        <div class="col-md-2"><button type="submit" class="btn btn-success w-100">Filtrar</button></div>
    </form>
</div>
<div class="card mt-4 p-4">
    <h5>Total: {{ total_reportes }}</h5>
    <table class="table mt-3">
        <tr><th>ID</th><th>Tipo</th><th>Descripción</th><th>Ubicación</th><th>Prioridad</th><th>Fecha</th><th>Acciones</th></tr>
        {% for r in reportes %}
        <tr>
            <td>#{{ r.id }}</td>
            <td>
                {% if usando_firestore %}
                <span class="badge bg-secondary">
                    {{ r.tipo_residuo_display|default:r.tipo_residuo|default:"Sin clasificar" }}
                </span>
                {% else %}
                <span class="badge bg-secondary">{{ r.get_tipo_residuo_display }}</span>
                {% endif %}
            </td>
            <td>{{ r.descripcion|default:""|truncatewords:10 }}</td>
            <td>{{ r.direccion|default:""|truncatewords:5 }}</td>
            <td>
                {% if usando_firestore %}
                <span class="badge badge-prioridad-{{ r.prioridad }}">
                    {{ r.prioridad_display|default:r.prioridad }}
                </span>
                {% else %}
                <span class="badge badge-prioridad-{{ r.prioridad }}">{{ r.get_prioridad_display }}</span>
                {% endif %}
            </td>
            <td>{{ r.fecha_reporte|date:"d/m/Y" }}</td>
            <td>
                {% if usando_firestore %}
                    <span class="badge bg-info">{{ r.estado_display|default:r.estado }}</span>
                {% else %}
                    {% if r.estado == 'asignado' or r.estado == 'en_proceso' %}
                        <a href="{% url 'cerrar_reporte' r.id %}" class="btn btn-success btn-sm">
                            <i class="bi bi-camera"></i> Cerrar Reporte
                        </a>
                    {% else %}
                        <span class="badge bg-info">{{ r.get_estado_display }}</span>
                    {% endif %}
                {% endif %}
            </td>
        </tr>
        {% empty %}<tr><td colspan="7" class="text-center">No hay reportes</td></tr>{% endfor %}
    </table>
</div>
{% endblock %}
